fastcgi_cache_path /etc/nginx/WP_CUSTOM_DOMAIN_CONFIGNAME/cache levels=1:2 keys_zone=WP_CUSTOM_DOMAIN_CONFIGNAME:100m inactive=60m;

server {
    server_name WP_CUSTOM_DOMAIN_CONFIGNAME www.WP_CUSTOM_DOMAIN_CONFIGNAME;
    root /var/www/WP_CUSTOM_DOMAIN_CONFIGNAME;

    index index.php index.html index.htm;

    set $skip_cache 0;

    # POST requests and urls with a query string should always go to PHP
    if ($request_method = POST) {
        set $skip_cache 1;
    }
    if ($query_string != "") {
        set $skip_cache 1;
    }

    # Don’t cache uris containing the following segments
    if ($request_uri ~* "/wp-admin/|/xmlrpc.php|wp-.*.php|/feed/|index.php|sitemap(_index)?.xml") {
        set $skip_cache 1;
    }

    # Don’t use the cache for logged in users or recent commenters
    if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
        set $skip_cache 1;
    }

    ## Disable .htaccess and other hidden files
    location ~ /\.(?!well-known).* {
        deny all;
        access_log off;
        log_not_found off;
        return 404;
    }

    # UNCOMMENT AFTER INSTALLATION
    # location ~ readme.txt|readme.md|readme.html|changelog.txt|changelog.md|changelog.html {
    #     deny all;
    #     return 404;
    # }

    location = /wp-admin/install.php
    {
        deny all;
        return 404;
    }

    location = /wp-includes/admin-bar.php
    {
        deny all;
        return 404;
    }

    location ~* /wp-content/uploads/(?:[^.]+$|.*\.(?!bmp$|gif$|tiff$|jpeg$|jpg$|csv$|png$|ico$|zip$|pdf$|ttf$)) {
        deny all;
        return 404;
    }


    ## WordPress Perm links config ##
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    ## Add trailing slash to */wp-admin requests.
    #rewrite /wp-admin$ $scheme://$host$uri/ permanent;

    ## Deal with sitemap wordpress plugin urls ##
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.xml$ "/index.php?xml_sitemap=params=$2" last;
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.xml\.gz$ "/index.php?xml_sitemap=params=$2;zip=true" last;
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.html$ "/index.php?xml_sitemap=params=$2;html=true" last;
    rewrite ^/sitemap(-+([a-zA-Z0-9_-]+))?\.html.gz$ "/index.php?xml_sitemap=params=$2;html=true;zip=true" last;

    # Directives to send expires headers and turn off 404 error logging.
    location ~* ^.+\.(ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|rss|atom|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ {
       access_log off; log_not_found off; expires max;
    }

    location ~ /\.ht {
        deny all;
        return 404;
    }

    ## Okay, Pass all .php files onto a php-fpm/php-fcgi server.
    index index.php;
    location ~ [^/]\.php(/|$) {
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        if (!-f $document_root$fastcgi_script_name) {
            return 404;
        }

        set $skip_cache 1;

        fastcgi_cache WP_CUSTOM_DOMAIN_CONFIGNAME;
        fastcgi_cache_valid 200 60m;
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;

        ## Setting works on Ubuntu/Debian Linux
        ### This is a robust solution for path info security issue and works with "cgi.fix_pathinfo = 1" in /etc/php.ini (default)
        include /etc/nginx/fastcgi_params;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass php;
        add_header X-FastCGI-Cache $upstream_cache_status;

        set $cache_header_var 'public, max-age=360';
        if ($skip_cache = 1)
        {
            set $cache_header_var 'private';
        }
        add_header Cache-Control $cache_header_var;
    }


    error_page 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 421 422 423 424 425 426 428 429 431 451 500 501 502 503 504 505 506 507 508 510 511 /error_404.php;

    location = /error_404.php {
        ssi on;
        internal;
        auth_basic off;
    }
    http2 on;

    listen 80;
    listen [::]:80 ipv6only=on;

}


map $status $status_text {
  400 'Bad Request';
  401 'Unauthorized';
  402 'Payment Required';
  403 'Forbidden';
  404 'Not Found';
  405 'Method Not Allowed';
  406 'Not Acceptable';
  407 'Proxy Authentication Required';
  408 'Request Timeout';
  409 'Conflict';
  410 'Gone';
  411 'Length Required';
  412 'Precondition Failed';
  413 'Payload Too Large';
  414 'URI Too Long';
  415 'Unsupported Media Type';
  416 'Range Not Satisfiable';
  417 'Expectation Failed';
  418 'I\'m a teapot';
  421 'Misdirected Request';
  422 'Unprocessable Entity';
  423 'Locked';
  424 'Failed Dependency';
  425 'Too Early';
  426 'Upgrade Required';
  428 'Precondition Required';
  429 'Too Many Requests';
  431 'Request Header Fields Too Large';
  451 'Unavailable For Legal Reasons';
  500 'Internal Server Error';
  501 'Not Implemented';
  502 'Bad Gateway';
  503 'Service Unavailable';
  504 'Gateway Timeout';
  505 'HTTP Version Not Supported';
  506 'Variant Also Negotiates';
  507 'Insufficient Storage';
  508 'Loop Detected';
  510 'Not Extended';
  511 'Network Authentication Required';
  default 'Something is wrong';
}
